let animations={buttonLoading:e=>{e.classList.add("loading"),e.setAttribute("disabled",!0)},buttonLoadingDone:e=>{e.classList.remove("loading"),e.removeAttribute("disabled")},showSkeletonLoading:(e,t=5)=>{var r=document.createDocumentFragment();for(let e=0;e<t;e++){var o=document.createElement("div");o.className="skeleton-loader",r.appendChild(o)}e.appendChild(r)},removeSkeletonLoading:e=>{e.querySelectorAll(".skeleton-loader").forEach(e=>e.remove())},initLazyLoading:()=>{let t=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(e.target.classList.add("product-item"),t.unobserve(e.target))})},{root:null,rootMargin:"50px",threshold:.1});document.querySelectorAll(".list-group-item").forEach(e=>{t.observe(e)})},optimizeForDevice:()=>{var e=window.matchMedia("(prefers-reduced-motion: reduce)").matches,t=window.matchMedia("(max-width: 768px)").matches;(e||t)&&(document.documentElement.style.setProperty("--animation-duration","0.2s"),document.body.classList.add("reduced-motion"))},initTouchFeedback:()=>{let t={passive:!0};document.querySelectorAll(".btn, .list-group-item, #floating-order-button, #floating-history-button").forEach(e=>{e.addEventListener("touchstart",()=>{},t)})},init:()=>{animations.optimizeForDevice(),animations.initLazyLoading(),animations.initTouchFeedback(),document.querySelectorAll(".btn").forEach(t=>{let r=t.onclick;t.onclick=async e=>{animations.buttonLoading(t),r&&await r(e),animations.buttonLoadingDone(t)}});["filterProductList","clearFilters","clearOrder","sendOrder","darkModeToggle","showSelectedOnly","clearSearch","helpButton","copyOrder1","sendOrder1","clearOrder1","floating-order-button","floating-history-button","history-sort","clearHistorySearch"].forEach(e=>{let t=document.getElementById(e);t&&t.addEventListener("click",()=>{var e=t.id.toLowerCase().includes("clear")||t.id.toLowerCase().includes("delete");e=e?"medium":"light",navigator.vibrate&&("medium"===e?navigator.vibrate(50):"double"===e?navigator.vibrate([40,30,40]):navigator.vibrate(20))})})}},selectedFilters=(document.addEventListener("DOMContentLoaded",animations.init),{});function getAllKeys(e){let t=new Set;return e.forEach(e=>{Object.keys(e).forEach(e=>t.add(e))}),Array.from(t)}function getUniqueValues(e,t){let r=new Set;return e.forEach(e=>{null!=e[t]&&""!==e[t]&&r.add(String(e[t]).trim())}),Array.from(r).sort()}function openFilterModal(){productsData&&productsData.productDirectory&&0<productsData.productDirectory.length&&populateFilterOptions(),updateFilterCheckboxStates(),resetFocus()}function populateTabContentForCategory(a,d){var e;0<d.children.length?updateFilterCheckboxStates():0===(e=getUniqueValues(productsData.productDirectory,a)).length?d.innerHTML='<p class="text-muted">No options available</p>':(e.forEach(e=>{var t=document.createElement("div"),r=(t.classList.add("form-check","mb-2"),document.createElement("input")),o=(r.classList.add("form-check-input","filter-checkbox"),r.type="checkbox",r.value=e,r.id=`filter-${a.replace(/[\s\.]/g,"-")}-`+e.replace(/[\s\.]/g,"-"),r.dataset.filterKey=a,document.createElement("label"));o.classList.add("form-check-label"),o.htmlFor=r.id,o.textContent=e,t.appendChild(r),t.appendChild(o),d.appendChild(t),r.addEventListener("change",e=>{var t=e.target.dataset.filterKey;let r=e.target.value;e.target.checked?(selectedFilters[t]||(selectedFilters[t]=[]),selectedFilters[t].includes(r)||selectedFilters[t].push(r)):selectedFilters[t]&&(selectedFilters[t]=selectedFilters[t].filter(e=>e!==r),0===selectedFilters[t].length)&&delete selectedFilters[t],updateClearFiltersButtonStyle()})}),updateFilterCheckboxStates())}function populateFilterOptions(){let a=document.getElementById("list-tab"),d=document.getElementById("nav-tabContent");if(a&&d){a.innerHTML="";var t,r={"Product Type":"Product Type","Group Name":"Group Name","Prod. Category":"Product Category","Face Type":"Face Type","Core Type":"Core Type","Grade Type":"Grade Type","Brand Mark":"Brand Mark"};let e=!(d.innerHTML="");for(t in r){var n=r[t];if(0<getUniqueValues(productsData.productDirectory,t).length){var s=`list-${t.replace(/[\s\.]/g,"-")}-list`;let r=t.replace(/[\s\.]/g,"-")+"-tab-pane",o=document.createElement("button");o.classList.add("list-group-item","list-group-item-action"),e&&(o.classList.add("active"),o.setAttribute("aria-current","true")),o.id=s,o.dataset.bsToggle="list",o.dataset.bsTarget="#"+r,o.type="button",o.role="tab",o.setAttribute("aria-controls",r),o.textContent=n,o.dataset.filterKey=t,a.appendChild(o);n=document.createElement("div");n.classList.add("tab-pane","fade"),e&&n.classList.add("show","active"),n.id=r,n.role="tabpanel",n.setAttribute("aria-labelledby",s),d.appendChild(n),o.addEventListener("click",e=>{e.preventDefault(),a.querySelectorAll(".list-group-item").forEach(e=>{e.classList.remove("active"),e.removeAttribute("aria-current")}),d.querySelectorAll(".tab-pane").forEach(e=>{e.classList.remove("show","active")}),o.classList.add("active"),o.setAttribute("aria-current","true");var t,e=document.getElementById(r);e&&(e.classList.add("show","active"),t=o.dataset.filterKey)&&populateTabContentForCategory(t,e)}),e&&(populateTabContentForCategory(t,n),e=!1)}}updateClearFiltersButtonStyle()}else console.error("Filter modal elements not found")}function updateFilterCheckboxStates(){document.querySelectorAll(".filter-checkbox").forEach(e=>{var t=e.dataset.filterKey,r=e.value,t=selectedFilters[t]&&selectedFilters[t].includes(r),r=(e.checked=t,e.nextElementSibling);r&&(t?(r.style.fontWeight="bold",r.style.color="#0d6efd"):(r.style.fontWeight="normal",r.style.color=""))})}function applyFilters(){let e=productsData.productDirectory;for(let r in selectedFilters)if(selectedFilters.hasOwnProperty(r)&&0<selectedFilters[r].length){let t=selectedFilters[r];e=e.filter(e=>{e=e[r];return null!=e&&t.includes(String(e).trim())})}displayProducts(e),resetFocus();var t=Object.keys(selectedFilters).length,r=e.length;0<t&&displayFeedbackMessage(`Applied ${t} filter(s). Showing ${r} product(s).`,"info")}function clearFilters(){selectedFilters={},document.querySelectorAll(".filter-checkbox").forEach(e=>{e.checked=!1;e=e.nextElementSibling;e&&(e.style.fontWeight="normal",e.style.color="")}),displayProducts(productsData.productDirectory),updateClearFiltersButtonStyle(),resetFocus(),"function"==typeof displayFeedbackMessage&&displayFeedbackMessage("Filters cleared. Showing all products.","success")}function filterProductsBySelectedFilters(o){return productsData.productDirectory.filter(e=>{for(var t in o)if(o.hasOwnProperty(t)&&0<o[t].length){var r=e[t];if(null==r||!o[t].includes(String(r).trim()))return!1}return!0})}function updateClearFiltersButtonStyle(){var e=document.getElementById("filterProductList"),t=document.getElementById("clearFilters"),r=0<Object.keys(selectedFilters).length,o=Object.keys(selectedFilters).reduce((e,t)=>e+(selectedFilters[t]?selectedFilters[t].length:0),0);e&&(e.innerHTML=r?`
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                Filter (${o})
            `:`
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                Filters
            `),t&&(r?(t.classList.remove("d-none"),t.classList.add("d-flex")):(t.classList.add("d-none"),t.classList.remove("d-flex")))}document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("filterModal");e&&e.addEventListener("shown.bs.modal",openFilterModal),updateClearFiltersButtonStyle()});let helpModalLoaded=!1;async function loadHelpModal(){if(!helpModalLoaded)try{var t=await fetch("assets/help-modal-content.html");if(!t.ok)throw new Error("Failed to load help modal: "+t.status);var e=await t.text(),r=document.querySelector("#help-modal .modal-content");r&&(r.innerHTML=e,helpModalLoaded=!0)}catch(e){console.error("Error loading help modal:",e);t=document.querySelector("#help-modal .modal-content");t&&(t.innerHTML=`
                <div class="modal-header">
                    <h5 class="modal-title">Help</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Unable to load help content. Please refresh the page and try again.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            `)}}document.addEventListener("DOMContentLoaded",()=>{var e=document.getElementById("help-modal");e&&e.addEventListener("show.bs.modal",loadHelpModal)});let ORDER_HISTORY_KEY="orderHistory",LAST_CLEANUP_KEY="lastCleanup",MAX_HISTORY_ITEMS=100,CLEANUP_DAYS=7,MILLISECONDS_PER_DAY=864e5;function initializeOrderHistory(){cleanupOldOrders()}function saveOrderToHistory(e,t="sent",r="whatsapp"){try{var o,a,d,n;return e&&0!==e.length?(o=getOrderHistory(),n={id:d=(a=Date.now())+"_"+Math.random().toString(36).substr(2,9),timestamp:a,dateCreated:new Date(a).toISOString(),products:[...e],totalItems:e.reduce((e,t)=>e+t.quantity,0),orderText:formatOrderText(sortProducts(e)),action:t,sentVia:r},o.unshift(n),o.length>MAX_HISTORY_ITEMS&&o.splice(MAX_HISTORY_ITEMS),localStorage.setItem(ORDER_HISTORY_KEY,JSON.stringify(o)),console.log("Order saved to history: "+d),!0):(console.warn("Cannot save empty order to history"),!1)}catch(e){return console.error("Error saving order to history:",e),"QuotaExceededError"===e.name&&displayFeedbackMessage("Storage limit reached. Please clear some history.","error"),!1}}function getOrderHistory(){try{var e,t=localStorage.getItem(ORDER_HISTORY_KEY);return t?(e=JSON.parse(t),Array.isArray(e)?e:(console.warn("Invalid history format, resetting..."),localStorage.setItem(ORDER_HISTORY_KEY,JSON.stringify([])),[])):[]}catch(e){return console.error("Error loading order history:",e),localStorage.setItem(ORDER_HISTORY_KEY,JSON.stringify([])),[]}}function getOrderById(t){return getOrderHistory().find(e=>e.id===t)||null}function deleteOrderFromHistory(t){try{var e=getOrderHistory(),r=e.filter(e=>e.id!==t);return r.length===e.length?(console.warn("Order not found in history:",t),!1):(localStorage.setItem(ORDER_HISTORY_KEY,JSON.stringify(r)),console.log("Order deleted from history: "+t),!0)}catch(e){return console.error("Error deleting order from history:",e),!1}}function cleanupOldOrders(){try{var e=getOrderHistory(),r=Date.now();let t=r-CLEANUP_DAYS*MILLISECONDS_PER_DAY;var o=e.filter(e=>e.timestamp>=t),a=e.length-o.length;return 0<a&&(localStorage.setItem(ORDER_HISTORY_KEY,JSON.stringify(o)),localStorage.setItem(LAST_CLEANUP_KEY,r.toString()),console.log(`Cleaned up ${a} old orders`),0<a)&&displayFeedbackMessage(`Cleaned up ${a} old order`+(1<a?"s":""),"success"),a}catch(e){return console.error("Error during cleanup:",e),0}}function searchOrders(e){if(!e||""===e.trim())return getOrderHistory();var t=getOrderHistory();let r=e.toLowerCase().trim();return t.filter(e=>!!(e.orderText.toLowerCase().includes(r)||e.products.some(e=>e.productName.toLowerCase().includes(r))||formatDateLabel(new Date(e.timestamp)).toLowerCase().includes(r)||e.totalItems.toString().includes(r)))}function sortOrderHistory(e,t="newest"){var r=[...e];switch(t){case"newest":r.sort((e,t)=>t.timestamp-e.timestamp);break;case"oldest":r.sort((e,t)=>e.timestamp-t.timestamp);break;case"most":r.sort((e,t)=>t.totalItems-e.totalItems);break;case"least":r.sort((e,t)=>e.totalItems-t.totalItems);break;default:r.sort((e,t)=>t.timestamp-e.timestamp)}return r}function getOrderHistoryCount(){return getOrderHistory().length}function clearAllHistory(){try{return localStorage.setItem(ORDER_HISTORY_KEY,JSON.stringify([])),localStorage.setItem(LAST_CLEANUP_KEY,Date.now().toString()),console.log("All order history cleared"),!0}catch(e){return console.error("Error clearing history:",e),!1}}function formatDateLabel(e){var t=new Date,e=new Date(e),t=new Date(t.getFullYear(),t.getMonth(),t.getDate()),r=new Date(e.getFullYear(),e.getMonth(),e.getDate()),t=Math.floor((t-r)/MILLISECONDS_PER_DAY);return 0===t?"Today":1===t?"Yesterday":t<7?["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e.getDay()]:e.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}function formatTimeLabel(e){return new Date(e).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}function groupOrdersByDate(e){let r={};return e.forEach(e=>{var t=formatDateLabel(new Date(e.timestamp));r[t]||(r[t]={label:t,fullDate:new Date(e.timestamp).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),orders:[]}),r[t].orders.push(e)}),r}document.addEventListener("DOMContentLoaded",()=>{initializeOrderHistory()});let currentHistorySort="newest",currentHistorySearch="";function openOrderHistory(){cleanupOldOrders(),new bootstrap.Modal(document.getElementById("history-modal")).show(),updateHistoryBadge()}function closeOrderHistory(){var e=document.getElementById("history-modal"),e=bootstrap.Modal.getInstance(e);e&&e.hide()}function renderOrderHistory(){var o=document.getElementById("history-container");if(o){let e=getOrderHistory();if(0===(e=sortOrderHistory(e=currentHistorySearch?searchOrders(currentHistorySearch):e,currentHistorySort)).length)o.innerHTML=renderEmptyState();else{let t=groupOrdersByDate(e),r="";var a=Object.keys(t);"newest"!==currentHistorySort&&"most"!==currentHistorySort&&"least"!==currentHistorySort&&"oldest"===currentHistorySort&&a.reverse(),a.forEach(e=>{e=t[e];r+=renderDateGroup(e)}),o.innerHTML=r}}else console.error("History container not found")}function renderEmptyState(){return currentHistorySearch&&""!==currentHistorySearch.trim()?`
            <div class="history-empty-state">
                <div class="empty-icon">üîç</div>
                <h4>No Results Found</h4>
                <p>No orders match "${currentHistorySearch}"</p>
                <button class="btn btn-secondary" onclick="clearHistorySearch()">Clear Search</button>
            </div>
        `:`
        <div class="history-empty-state">
            <div class="empty-icon">üì≠</div>
            <h4>No Order History Yet</h4>
            <p>Your sent and copied orders will appear here.</p>
            <p class="text-muted">Orders are automatically saved for 7 days.</p>
            <button class="btn btn-primary" onclick="closeOrderHistory()">Start Creating Orders ‚Üí</button>
        </div>
    `}function renderDateGroup(e){let t=`
        <div class="history-date-group">
            <div class="date-group-header">
                <span class="date-icon">üìÖ</span>
                <span class="date-label">${e.label}</span>
                ${e.label!==e.fullDate?`<span class="date-full text-muted">- ${e.fullDate}</span>`:""}
            </div>
            <div class="date-group-orders">
    `;return e.orders.forEach(e=>{t+=renderOrderCard(e)}),t+=`
            </div>
        </div>
    `}function renderOrderCard(e){var t=formatTimeLabel(new Date(e.timestamp)),r="sent"===e.action?"status-sent":"status-copied",o=e.products.slice(0,2),a=e.products.length-o.length;let d=o.map(e=>e.productName+" - "+e.quantity).join(", ");return 0<a&&(d+=` ... and ${a} more`),`
        <div class="history-order-card ${r}" data-order-id="${e.id}">
            <div class="order-card-header">
                <div class="order-time">
                    <span class="time-icon">‚è∞</span>
                    <span class="time-label">${t}</span>
                </div>
                <div class="order-count">
                    <span class="count-icon">üì¶</span>
                    <span class="count-label">${e.totalItems} items</span>
                </div>
            </div>
            <div class="order-card-preview">
                ${d}
            </div>
            <div class="order-card-actions">
                <button class="btn btn-sm btn-outline-primary d-flex align-items-center gap-1" onclick="viewOrderDetails('${e.id}')" title="View full order details">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    View
                </button>
                <button class="btn btn-sm btn-outline-info d-flex align-items-center gap-1" onclick="editOrderFromHistory('${e.id}')" title="Load order for editing">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    Edit
                </button>
                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1" onclick="copyOrderFromHistory('${e.id}')" title="Copy order text">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    Copy
                </button>
                <button class="btn btn-sm btn-outline-danger d-flex align-items-center gap-1" onclick="confirmDeleteOrder('${e.id}')" title="Delete this order">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    Delete
                </button>
            </div>
        </div>
    `}function updateHistoryBadge(){var e=getOrderHistoryCount(),t=document.getElementById("history-badge");t&&(0<e?(t.textContent=99<e?"99+":e,t.style.display="inline"):t.style.display="none")}function handleHistorySearch(e){currentHistorySearch=e,renderOrderHistory()}function clearHistorySearch(){currentHistorySearch="";var e=document.getElementById("history-search");e&&(e.value=""),renderOrderHistory()}function handleHistorySort(e){currentHistorySort=e,renderOrderHistory()}function viewOrderDetails(e){var t=getOrderById(e);t?(document.getElementById("view-order-title").textContent=`Order Details - ${formatDateLabel(new Date(t.timestamp))} at `+formatTimeLabel(new Date(t.timestamp)),document.getElementById("view-order-content").textContent=t.orderText,document.getElementById("view-order-modal").dataset.orderId=e,new bootstrap.Modal(document.getElementById("view-order-modal")).show()):displayFeedbackMessage("Order not found","error")}function editOrderFromHistory(e){e=getOrderById(e);e?(clearOrder(),e.products.forEach(e=>{updateProductQuantityInOrder(e.productName,e.quantity)}),closeOrderHistory(),displayFeedbackMessage("‚úèÔ∏è Order loaded for editing. Modify and send as a new order.","success"),window.scrollTo({top:0,behavior:"smooth"})):displayFeedbackMessage("Order not found","error")}function copyOrderFromHistory(e){e=getOrderById(e);if(e)if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(e.orderText).then(()=>{displayFeedbackMessage("Order copied to clipboard!","success")}).catch(e=>{console.error("Failed to copy:",e),displayFeedbackMessage("Failed to copy order","error")});else{var t=document.createElement("textarea");t.value=e.orderText,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();try{document.execCommand("copy"),displayFeedbackMessage("Order copied to clipboard!","success")}catch(e){displayFeedbackMessage("Failed to copy order","error")}document.body.removeChild(t)}else displayFeedbackMessage("Order not found","error")}function confirmDeleteOrder(e){confirm("Are you sure you want to delete this order from history?")&&(deleteOrderFromHistory(e)?(displayFeedbackMessage("Order deleted from history","success"),renderOrderHistory(),updateHistoryBadge()):displayFeedbackMessage("Failed to delete order","error"))}function copyFromViewModal(){copyOrderFromHistory(document.getElementById("view-order-modal").dataset.orderId)}function editFromViewModal(){var e=document.getElementById("view-order-modal").dataset.orderId,t=bootstrap.Modal.getInstance(document.getElementById("view-order-modal"));t&&t.hide(),editOrderFromHistory(e)}function sendAgainFromViewModal(){editOrderFromHistory(document.getElementById("view-order-modal").dataset.orderId);var e=bootstrap.Modal.getInstance(document.getElementById("view-order-modal"));e&&e.hide(),setTimeout(()=>{sendOrder()},500)}function attachHistoryEventListeners(){var e=document.getElementById("history-search"),e=(e&&e.addEventListener("input",e=>{handleHistorySearch(e.target.value)}),document.getElementById("history-sort"));e&&e.addEventListener("change",e=>{handleHistorySort(e.target.value)})}function confirmClearAllHistory(){confirm("Are you sure you want to delete ALL order history? This action cannot be undone.")&&(clearAllHistory()?(displayFeedbackMessage("All order history cleared","success"),renderOrderHistory(),updateHistoryBadge()):displayFeedbackMessage("Failed to clear history","error"))}document.addEventListener("DOMContentLoaded",()=>{updateHistoryBadge();var e=document.getElementById("history-modal");e&&(e.addEventListener("show.bs.modal",()=>{renderOrderHistory()}),attachHistoryEventListeners(),e.addEventListener("shown.bs.modal",()=>{var e=document.getElementById("history-search"),t="function"==typeof isMobileDevice&&isMobileDevice();e&&!t&&e.focus()}))});let currentFocusIndex=-1;function focusFirstVisibleItem(){var e=document.getElementById("product-list"),e=Array.from(e.children);resetFocus(),0<e.length?(e[currentFocusIndex=0].classList.add("focus"),e[0].scrollIntoView({block:"nearest",behavior:"smooth"})):currentFocusIndex=-1}function validatePointerAfterListChange(){var e=document.getElementById("product-list"),e=Array.from(e.children);currentFocusIndex>=e.length&&(resetFocus(),0<e.length)&&(e[currentFocusIndex=0].classList.add("focus"),e[0].scrollIntoView({block:"nearest",behavior:"smooth"}))}document.addEventListener("keydown",function(e){var t=document.getElementById("search-box"),r=document.getElementById("filter-modal"),o=document.getElementById("order-modal"),a=document.getElementById("help-modal"),d=document.getElementById("history-modal"),n=document.getElementById("order-text-popup"),r=r?.classList.contains("show"),o=o?.classList.contains("show"),a=a?.classList.contains("show"),d=d?.classList.contains("show"),n=n?.classList.contains("show");if(r||o||a||d||n)o?"Escape"===e.key&&(e.preventDefault(),document.querySelector("#order-modal .btn-close").click()):n&&("Escape"!==e.key&&(!e.ctrlKey||e.shiftKey||"o"!==e.key&&"O"!==e.key)?!e.ctrlKey||"c"!==e.key&&"C"!==e.key?e.ctrlKey&&"Delete"===e.key?(e.preventDefault(),clearOrder()):e.ctrlKey&&"Enter"===e.key&&(e.preventDefault(),sendOrder()):(e.preventDefault(),copyOrder()):(e.preventDefault(),toggleOrderPopup()));else if(e.ctrlKey&&e.shiftKey&&("f"===e.key||"F"===e.key))e.preventDefault(),document.getElementById("filterProductList").click();else if(e.ctrlKey&&e.shiftKey&&("o"===e.key||"O"===e.key))e.preventDefault(),document.getElementById("clearFilters").click();else if(e.ctrlKey&&"Delete"===e.key)e.preventDefault(),clearOrder();else if(e.ctrlKey&&"Backspace"===e.key)e.preventDefault(),clearSearch();else if(e.ctrlKey&&"Enter"===e.key)e.preventDefault(),sendOrder();else if(!e.ctrlKey||"c"!==e.key&&"C"!==e.key)if(!e.ctrlKey||"/"!==e.key&&"?"!==e.key)if(!e.ctrlKey||e.shiftKey||"o"!==e.key&&"O"!==e.key)if(!e.ctrlKey||"h"!==e.key&&"H"!==e.key)if(!e.ctrlKey||"s"!==e.key&&"S"!==e.key){!/^[a-zA-Z0-9]$/.test(e.key)&&"-"!==e.key&&" "!==e.key||e.ctrlKey||e.altKey||e.metaKey||(a="INPUT"===(r=document.activeElement).tagName||"TEXTAREA"===r.tagName,r===t)||a||(t.focus(),t.setSelectionRange(t.value.length,t.value.length)),"Backspace"===e.key&&document.activeElement!==t&&(e.preventDefault(),t.focus(),t.setSelectionRange(t.value.length,t.value.length)),"Delete"===e.key&&document.activeElement;d=document.getElementById("product-list"),o=Array.from(d.children);if(e.ctrlKey&&("ArrowUp"===e.key||"ArrowRight"===e.key)&&0<=currentFocusIndex&&currentFocusIndex<o.length)e.preventDefault(),(n=o[currentFocusIndex].dataset.productName)&&updateProductQuantityInOrder(n,1);else if(e.ctrlKey&&("ArrowDown"===e.key||"ArrowLeft"===e.key)&&0<=currentFocusIndex&&currentFocusIndex<o.length)e.preventDefault(),(r=o[currentFocusIndex].dataset.productName)&&updateProductQuantityInOrder(r,-1);else{if("ArrowDown"===e.key||"ArrowUp"===e.key){if(e.preventDefault(),0===o.length)return currentFocusIndex=-1,void t.focus();o.forEach(e=>e.classList.remove("focus","keyboard-focus")),document.activeElement===t&&(currentFocusIndex=-1),"ArrowDown"===e.key&&(-1===currentFocusIndex?(currentFocusIndex=0,t.blur()):currentFocusIndex<o.length-1&&currentFocusIndex++,0<=currentFocusIndex)&&currentFocusIndex<o.length&&(o[currentFocusIndex].classList.add("focus","keyboard-focus"),o[currentFocusIndex].scrollIntoView({block:"nearest",behavior:"smooth"})),"ArrowUp"===e.key&&(currentFocusIndex<=0?(o[0]&&o[0].classList.remove("focus","keyboard-focus"),t.focus(),currentFocusIndex=-1):0<=--currentFocusIndex&&o[currentFocusIndex]&&(o[currentFocusIndex].classList.add("focus","keyboard-focus"),o[currentFocusIndex].scrollIntoView({block:"nearest",behavior:"smooth"})))}"Enter"===e.key&&(0<=currentFocusIndex&&currentFocusIndex<o.length?(e.preventDefault(),(a=o[currentFocusIndex].querySelector(".product-info"))&&a.click()):document.activeElement===t&&({searchTerm:d,quantity:n,isValid:r}=parseSearchInput(t.value),r)&&null!==n&&(o=getFirstVisibleProductElement())&&(addToOrder(o.dataset.productName,n),filterProductsAndDisplay(t.value=d),resetFocus()))}}else e.preventDefault(),(a=document.getElementById("showSelectedOnly"))&&a.click();else e.preventDefault(),openOrderHistory();else e.preventDefault(),toggleOrderPopup();else e.preventDefault(),document.getElementById("helpButton").click();else e.preventDefault(),copyOrder()});let productListContainer=document.getElementById("product-list");if(productListContainer){let e=new MutationObserver(()=>{validatePointerAfterListChange()});e.observe(productListContainer,{childList:!0})}function resetFocus(){document.querySelectorAll(".list-group-item.focus, .list-group-item.keyboard-focus").forEach(e=>{e.classList.remove("focus","keyboard-focus")}),currentFocusIndex=-1}let searchBoxInput=document.getElementById("search-box"),productsData=(searchBoxInput&&searchBoxInput.addEventListener("input",function(){resetFocus();var e=document.getElementById("product-list");e&&Array.from(e.children).forEach(e=>e.classList.remove("focus","keyboard-focus"))}),window.onload=()=>{loadProducts(),applySavedTheme()},{productDirectory:[]}),openedProductForOrder=null,holdTimer=null,holdInterval=null,HOLD_DELAY=300,REPEAT_INTERVAL=100;async function loadProducts(){try{var e=await fetch("products.json");if(!e.ok)throw new Error("HTTP error! status: "+e.status);displayProducts((productsData=await e.json()).productDirectory),updateOrderList()}catch(e){console.error("Error loading products:",e)}}function displayProducts(e){let y=document.getElementById("product-list");var t=Array.from(y.children);e.map(e=>e.Product);let r=new Map,o=(t.forEach(e=>{e.dataset.productName&&r.set(e.dataset.productName,e)}),new Set);e.forEach((a,e)=>{let t=a.Product;var d=r.get(t);if(d){y.children[e]!==d&&y.insertBefore(d,y.children[e]||null);var n=d.querySelector(".product-checkbox"),s=selectedProducts.find(e=>e.productName===t),n=(n&&(n.checked=!!s),s?d.classList.add("added-to-order"):d.classList.remove("added-to-order"),d.querySelector(".quantity-display"));n&&(n.value=s?s.quantity:0)}else{let t=document.createElement("li"),r=(t.classList.add("list-group-item","list-group-item-action","product-item"),t.dataset.productName=a.Product,t.dataset.productType=a["Product Type"],t.dataset.productGroup=a["Group Name"],t.dataset.productGroupAlias=a["Group Alias"],t.dataset.productCategory=a["Prod. Category"],t.dataset.faceType=a["Face Type"]||"",t.dataset.coreType=a["Core Type"],t.dataset.gradeType=a["Grade Type"],t.dataset.brandMark=a["Brand Mark"],document.createElement("input"));r.classList.add("form-check-input","product-checkbox"),r.type="checkbox";d="checkbox-"+a.Product.replace(/\s/g,"-"),n=(r.id=d,r.title="Select "+a.Product,document.createElement("label"));n.setAttribute("for",d),n.classList.add("visually-hidden"),n.textContent="Select "+a.Product;let o=selectedProducts.find(e=>e.productName===a.Product);r.checked=!!o,o&&t.classList.add("added-to-order"),r.addEventListener("change",e=>{e.stopPropagation();e=o?o.quantity:0;r.checked?updateProductQuantityInOrder(a.Product,0===e?1:0):updateProductQuantityInOrder(a.Product,-e)});var s=document.createElement("div"),l=(s.classList.add("product-info"),s.onclick=e=>{e.stopPropagation(),openOrderModal(t)},document.createElement("span")),c=(l.classList.add("product-name"),l.textContent=a.Product,l.setAttribute("title","Click to view details"),document.createElement("div")),i=(c.classList.add("quantity-controls"),document.createElement("button")),u=(i.type="button",i.classList.add("btn","btn-outline-danger","btn-sm","qty-btn"),i.textContent="-",addHoldListeners(i,()=>updateProductQuantityInOrder(a.Product,-1)),document.createElement("input")),p=(u.type="number",u.classList.add("quantity-display","form-control-sm"),u.value=o?o.quantity:0,u.readOnly=!0,u.dataset.productName=a.Product,u.id="quantity-"+a.Product.replace(/\s/g,"-"),u.name="quantity-"+a.Product.replace(/\s/g,"-"),u.title="Quantity for "+a.Product,document.createElement("button"));p.type="button",p.classList.add("btn","btn-outline-success","btn-sm","qty-btn"),p.textContent="+",addHoldListeners(p,()=>updateProductQuantityInOrder(a.Product,1)),c.appendChild(i),c.appendChild(u),c.appendChild(p),s.appendChild(r),s.appendChild(n),s.appendChild(l),s.setAttribute("aria-labelledby",d+" "+l.id),t.appendChild(s),t.appendChild(c),t.addEventListener("click",function(e){e.target.closest(".quantity-controls")||e.target.classList.contains("product-checkbox")||"BUTTON"===e.target.tagName||"INPUT"===e.target.tagName||openOrderModal(t)}),y.insertBefore(t,y.children[e]||null)}o.add(t)}),t.forEach(e=>{o.has(e.dataset.productName)||y.removeChild(e)})}function addHoldListeners(e,t){let r,o,a=()=>{clearTimeout(r),clearInterval(o),e.classList.add("holding"),t(),r=setTimeout(()=>{o=setInterval(t,REPEAT_INTERVAL)},HOLD_DELAY)};var d=()=>{clearTimeout(r),clearInterval(o),e.classList.remove("holding")};e.addEventListener("mousedown",e=>{0===e.button&&(a(),e.preventDefault())}),e.addEventListener("mouseup",d),e.addEventListener("mouseleave",d),e.addEventListener("touchstart",e=>{e.preventDefault(),a()},{passive:!1}),e.addEventListener("touchend",d),e.addEventListener("touchcancel",d)}function openOrderModal(e){document.getElementById("modal-product-name").textContent=e.dataset.productName,document.getElementById("modal-product-type").innerHTML="<b>Product Type :</b> "+e.dataset.productType,document.getElementById("modal-face-type").innerHTML="<b>Face Type :</b> "+e.dataset.faceType,document.getElementById("modal-core-type").innerHTML="<b>Core Type :</b> "+e.dataset.coreType,document.getElementById("modal-grade-type").innerHTML="<b>Grade Type :</b> "+e.dataset.gradeType,document.getElementById("modal-brand-mark").innerHTML="<b>Brand Mark :</b> "+e.dataset.brandMark,openedProductForOrder=e,new bootstrap.Modal(document.getElementById("order-modal")).show()}function displayFeedbackMessage(e,t="warning",r=3e3){var o=document.getElementById("feedback-message");o&&o.remove();let a=document.createElement("div");a.id="feedback-message",a.classList.add("feedback-message",t),a.textContent=e,document.body.appendChild(a),a.offsetHeight,a.classList.add("show"),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>{a&&a.parentNode&&a.remove()},500)},r)}function toggleOrderPopup(){var e=document.getElementById("order-text-popup"),t=document.getElementById("selected-products"),r=document.getElementById("floating-order-button");e.classList.contains("show")?(e.classList.remove("show"),r&&(r.style.opacity="1")):(e.classList.add("show"),updateOrderList(),t.scrollTop=t.scrollHeight,r&&(r.style.opacity="0.5"))}function toggleDarkMode(){var e=document.body;e.classList.toggle("dark-mode"),e.classList.contains("dark-mode")?localStorage.setItem("theme","dark"):localStorage.setItem("theme","light"),updateDarkModeToggleIcon()}function applySavedTheme(){"dark"===localStorage.getItem("theme")?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode"),updateDarkModeToggleIcon()}function updateDarkModeToggleIcon(){var e=document.getElementById("darkModeToggle");e&&(document.body.classList.contains("dark-mode")?(e.innerHTML="üåô",e.setAttribute("title","Switch to Light Mode")):(e.innerHTML="üåû",e.setAttribute("title","Switch to Dark Mode")))}let selectedProducts=[],selectedProductsTextarea;function updateProductQuantityInOrder(o,a){var d=productsData.productDirectory.find(e=>e.Product===o);if(d){var n=selectedProducts.findIndex(e=>e.productName===o);let e=0,t=(e=-1<n?selectedProducts[n].quantity:e)+a,r=(t<0&&(t=0),document.querySelector(`li[data-product-name="${o}"]`));var a=r?r.querySelector(".quantity-display"):null,s=r?r.querySelector(".product-checkbox"):null;0<t?(d={productName:d.Product,productGroup:d["Group Name"],productGroupAlias:d["Group Alias"],productCategory:d["Prod. Category"],quantity:t},-1<n?selectedProducts[n]=d:selectedProducts.push(d),s&&(s.checked=!0),r&&(r.classList.remove("removed-from-order"),r.classList.add("added-to-order"))):(selectedProducts=selectedProducts.filter(e=>e.productName!==o),s&&(s.checked=!1),r&&(r.classList.remove("added-to-order"),r.classList.add("removed-from-order"),setTimeout(()=>{r.classList.remove("removed-from-order")},300))),a&&(a.value=t,a.title="Quantity for "+o),updateOrderList()}else console.error("Product not found:",o)}function addToOrder(t,e){var r;t&&void 0!==e?(r=(r=selectedProducts.find(e=>e.productName===t))?r.quantity:0,updateProductQuantityInOrder(t,e-r)):console.error("Product name or quantity is missing for addToOrder.")}function clearOrder(e){e&&(e.preventDefault(),e.stopPropagation()),selectedProducts=[],document.querySelectorAll("#product-list .product-item").forEach(e=>{var t=e.querySelector(".product-checkbox"),r=e.querySelector(".quantity-display");t&&(t.checked=!1),r&&(r.value=0),e.classList.remove("added-to-order"),e.classList.remove("removed-from-order")}),void 0!==showSelectedOnly&&showSelectedOnly&&(showSelectedOnly=!1,"function"==typeof updateShowSelectedOnlyButton)&&updateShowSelectedOnlyButton(),updateOrderList(),clearSearch(),displayFeedbackMessage("Order cleared successfully!","success")}function updateOrderList(){if(selectedProductsTextarea||(selectedProductsTextarea=document.getElementById("selected-products"))){var e=sortProducts(selectedProducts);let a="",d=null;e.forEach(e=>{var{productGroupAlias:e,productName:t,productGroup:r,quantity:o}=e;d!==e&&(a+=`
*${r}* :
`,d=e),a+=t+` - ${o}
`});e=calculateTotalQuantity(),e=(a+=`
Total : *${e}* Pcs.
`,selectedProductsTextarea.value=a.trim(),document.getElementById("order-text-popup"));e&&e.classList.contains("show")&&(selectedProductsTextarea.scrollTop=selectedProductsTextarea.scrollHeight)}else console.warn("Order textarea not found in DOM.")}function calculateTotalQuantity(){return selectedProducts.reduce((e,t)=>e+t.quantity,0)}document.addEventListener("DOMContentLoaded",()=>{selectedProductsTextarea=document.getElementById("selected-products")});let deferredPrompt,installBtn=document.getElementById("pwa-install-btn"),iosModal=document.getElementById("ios-install-modal"),isInstalled=window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone;function showInstallButton(){installBtn.style.display="flex",installBtn.classList.add("fade-in"),setTimeout(()=>{installBtn?.classList.replace("fade-in","fade-out"),setTimeout(()=>{installBtn&&(installBtn.style.display="none")},500)},1e4)}window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredPrompt=e,!isInstalled&&window.innerWidth<768&&showInstallButton()});let isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,searchBox=(isIOS&&!isInstalled&&window.innerWidth<768&&showInstallButton(),installBtn?.addEventListener("click",async()=>{var e;deferredPrompt?(deferredPrompt.prompt(),e=(await deferredPrompt.userChoice).outcome,"accepted"===e&&(installBtn.style.display="none"),deferredPrompt=null):isIOS&&new bootstrap.Modal(iosModal).show()}),window.addEventListener("appinstalled",()=>{installBtn.style.display="none",deferredPrompt=null}),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/service-worker.js").catch(e=>console.log("SW registration failed:",e))}),document.getElementById("search-box"));function scrollSearchBoxToTop(){var e=searchBox.getBoundingClientRect().top+window.scrollY;window.scrollTo({top:e-15,behavior:"smooth"})}function isMobileDevice(){return/Android|webOS|iPhone|iPad|IPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768}function debounce(t,r){let o;return function(...e){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),t(...e)},r)}}function parseSearchInput(e){var t=e.lastIndexOf("-");if(-1!==t&&t<e.length-1){var r=e.substring(0,t).trim(),t=e.substring(t+1).trim(),o=parseInt(t,10);if(!isNaN(o)&&0<=o&&/^\d+$/.test(t))return{searchTerm:r.replace(/-/g,""),quantity:o,isValid:!0}}return{searchTerm:e.trim().replace(/-/g,""),quantity:null,isValid:!1}}function containsInOrder(e,t){var r=e.toLowerCase(),o=t.toLowerCase();let a=0,d=0;for(;a<r.length&&d<o.length;)r[a]===o[d]&&d++,a++;return d===o.length}function filterProductsAndDisplay(e="",t={}){let a=e.trim().toUpperCase(),r=[];a?0===(r=productsData.productDirectory.filter(e=>containsInOrder((e.Product||"").toUpperCase(),a))).length&&(r=productsData.productDirectory.filter(e=>{var t=(e["Brand Mark"]||"").toUpperCase(),r=(e["Core Type"]||"").toUpperCase(),o=(e["Grade Type"]||"").toUpperCase(),e=(e["Product Type"]||"").toUpperCase();return containsInOrder(t,a)||containsInOrder(r,a)||containsInOrder(o,a)||containsInOrder(e,a)})):r=productsData.productDirectory,displayProducts(r),resetFocus(),t.skipScroll||scrollSearchBoxToTop()}searchBox.addEventListener("focus",()=>{scrollSearchBoxToTop()});let lastDebouncedHandler=null,lastDebounceDelay=null;function dynamicDebounceHandler(){var e=searchBox.value.includes("-")?1e3:0,t=(lastDebouncedHandler&&searchBox.removeEventListener("input",lastDebouncedHandler),debounce(()=>{var{searchTerm:e,quantity:t,isValid:r}=parseSearchInput(searchBox.value);filterProductsAndDisplay(e),r&&null!==t&&(r=getFirstVisibleProductElement())&&(addToOrder(r.dataset.productName,t),searchBox.value=e),isMobileDevice()||focusFirstVisibleItem()},e));searchBox.addEventListener("input",t),lastDebouncedHandler=t,lastDebounceDelay=e}function clearSearch(){filterProductsAndDisplay(searchBox.value=""),resetFocus()}function getFirstVisibleProductElement(){var e=document.getElementById("product-list");return e&&0<e.children.length?e.children[0]:null}function focusFirstVisibleItem(){var e=document.getElementById("product-list"),e=Array.from(e.children);resetFocus(),0<e.length?(currentFocusIndex=1,e[0].classList.add("focus"),e[0].scrollIntoView({block:"nearest",behavior:"smooth"})):currentFocusIndex=-1}function resetFocus(){document.querySelectorAll(".list-group-item.focus").forEach(e=>{e.classList.remove("focus")}),currentFocusIndex=-1}searchBox.addEventListener("input",function(){(searchBox.value.includes("-")?1e3:0)!==lastDebounceDelay&&dynamicDebounceHandler()}),window.addEventListener("DOMContentLoaded",dynamicDebounceHandler);let originalFilterProductsAndDisplay=filterProductsAndDisplay,originalClearSearch=(filterProductsAndDisplay=function(e=""){originalFilterProductsAndDisplay(e),isMobileDevice()||focusFirstVisibleItem()},clearSearch);if("function"==typeof clearFilters){let e=clearFilters;clearFilters=function(){e(),isMobileDevice()||focusFirstVisibleItem()}}let showSelectedOnly=!(clearSearch=function(){originalClearSearch(),isMobileDevice()||focusFirstVisibleItem()}),showSelectedOnlyBtn=document.getElementById("showSelectedOnly"),showSelectedOnlyIcon=document.getElementById("showSelectedOnlyIcon");function updateShowSelectedOnlyButton(){showSelectedOnly?(showSelectedOnlyBtn.classList.add("active"),showSelectedOnlyBtn.classList.add("btn-primary","shadow-sm"),showSelectedOnlyIcon.innerHTML=`
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="white" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>`):(showSelectedOnlyBtn.classList.remove("active"),showSelectedOnlyBtn.classList.remove("btn-primary","shadow-sm"),showSelectedOnlyIcon.innerHTML=`
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6a11cb" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>`)}showSelectedOnlyBtn&&showSelectedOnlyBtn.addEventListener("click",function(){showSelectedOnly=!showSelectedOnly,updateShowSelectedOnlyButton(),showSelectedOnly&&(searchBox.value=""),filterProductsAndDisplay(searchBox.value,{skipScroll:!0})});let originalFilterProductsAndDisplay2=filterProductsAndDisplay;if(filterProductsAndDisplay=function(t="",e={}){let r;showSelectedOnly?(displayProducts(r=t.trim()?selectedProducts.map(t=>productsData.productDirectory.find(e=>e.Product===t.productName)).filter(Boolean).filter(e=>e.Product.toUpperCase().includes(t.trim().toUpperCase())):selectedProducts.map(t=>productsData.productDirectory.find(e=>e.Product===t.productName)).filter(Boolean)),resetFocus(),e.skipScroll||scrollSearchBoxToTop(),isMobileDevice()||focusFirstVisibleItem()):originalFilterProductsAndDisplay2(t)},"function"==typeof updateOrderList){let e=updateOrderList;updateOrderList=function(){e(),showSelectedOnly&&filterProductsAndDisplay(searchBox.value)}}function hasProducts(e){return 0!==e.length||(displayFeedbackMessage("No products in the order. Please add products.","warning"),!1)}function sortProducts(e){return[...e].sort((e,t)=>{var r,o=e.productGroupAlias.localeCompare(t.productGroupAlias);return 0===o?0===(r=e.productCategory.localeCompare(t.productCategory))?e.productName.localeCompare(t.productName):r:o})}function copyOrder(){if(hasProducts(selectedProducts)){let e=sortProducts(selectedProducts);var t=formatOrderText(e);if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(t).then(()=>{displayFeedbackMessage("Order copied to clipboard!","success"),saveOrderToHistory(e,"copied","clipboard"),updateHistoryBadge()}).catch(e=>{console.error("Failed to copy order text: ",e),displayFeedbackMessage("Failed to copy order. Please try again.","error")});else{var r=document.createElement("textarea");r.value=t,r.style.position="fixed",r.style.opacity="0",document.body.appendChild(r),r.select();try{if(!document.execCommand("copy"))throw new Error("execCommand failed");displayFeedbackMessage("Order copied to clipboard (fallback)!","success"),saveOrderToHistory(e,"copied","clipboard"),updateHistoryBadge()}catch(e){console.error("Fallback: Failed to copy order text: ",e),displayFeedbackMessage("Failed to copy order. Please try manually.","error")}finally{document.body.removeChild(r)}}}}function sendOrder(){var e,t;hasProducts(selectedProducts)&&(e=sortProducts(selectedProducts),t=encodeURIComponent(formatOrderText(e)),window.open("https://wa.me/+916355360702?text="+t,"_blank"),displayFeedbackMessage("Order sent via WhatsApp!","success"),saveOrderToHistory(e,"sent","whatsapp"),updateHistoryBadge())}function formatOrderText(e){let a="",d=null;e.forEach(e=>{var{productGroupAlias:e,productName:t,productGroup:r,quantity:o}=e;d!==e&&(a+=`
*${r}* :
`,d=e),a+=t+` - ${o}
`});e=calculateTotalQuantity();return(a+=`
Total : *${e}* Pcs.
`).trim()}